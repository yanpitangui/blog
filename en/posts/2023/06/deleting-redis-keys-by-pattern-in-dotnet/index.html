<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Deleting Redis keys by pattern in dotnet - Yan Pitangui</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Problem: You want to delete more than one key at a time, probably by regex pattern Using Redis, you might be using something like the following to delete keys:
public class CacheManager { private readonly IDistributedCache _cache; public CacheManager(IDDistributedCache cache) { _cache = cache; } public async Task RemoveKeys() { await Cache.RemoveAsync(&#34;key-1&#34;); await Cache.RemoveAsync(&#34;key-2&#34;); await Cache.RemoveAsync(&#34;key-3&#34;); } } The only problem with this approach is that we perform a round-trip for each key deletion, that is, we call the redis server at each deletion."><meta property="og:image" content><meta property="og:title" content="Deleting Redis keys by pattern in dotnet"><meta property="og:description" content="Problem: You want to delete more than one key at a time, probably by regex pattern Using Redis, you might be using something like the following to delete keys:
public class CacheManager { private readonly IDistributedCache _cache; public CacheManager(IDDistributedCache cache) { _cache = cache; } public async Task RemoveKeys() { await Cache.RemoveAsync(&#34;key-1&#34;); await Cache.RemoveAsync(&#34;key-2&#34;); await Cache.RemoveAsync(&#34;key-3&#34;); } } The only problem with this approach is that we perform a round-trip for each key deletion, that is, we call the redis server at each deletion."><meta property="og:type" content="article"><meta property="og:url" content="https://yanpitangui.com/en/posts/2023/06/deleting-redis-keys-by-pattern-in-dotnet/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-15T15:35:58-03:00"><meta property="article:modified_time" content="2023-06-15T15:35:58-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Deleting Redis keys by pattern in dotnet"><meta name=twitter:description content="Problem: You want to delete more than one key at a time, probably by regex pattern Using Redis, you might be using something like the following to delete keys:
public class CacheManager { private readonly IDistributedCache _cache; public CacheManager(IDDistributedCache cache) { _cache = cache; } public async Task RemoveKeys() { await Cache.RemoveAsync(&#34;key-1&#34;); await Cache.RemoveAsync(&#34;key-2&#34;); await Cache.RemoveAsync(&#34;key-3&#34;); } } The only problem with this approach is that we perform a round-trip for each key deletion, that is, we call the redis server at each deletion."><script defer src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://yanpitangui.com/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://yanpitangui.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://yanpitangui.com/>Yan Pitangui</a></div><nav><a href=/en/posts/>All posts</a>
<a href=/en/tags/>Tags</a>
<a href=/en/about/>About me</a>
| <span id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://yanpitangui.com/js/themetoggle.js></script><nav aria-label="Language switcher"><span aria-label=en style="border-bottom:3px solid var(--callouctcolor)">en</span>
<a title=pt style=border:none href=https://yanpitangui.com/pt/posts/2023/06/deletando-chaves-do-redis-por-pattern-no-dotnet/ aria-label=pt>pt</a></nav></nav></header><main><article><div class=title><h1 class=title>Deleting Redis keys by pattern in dotnet</h1><div class=meta>Posted on Thursday, June 15, 2023</div></div><section class=body>2 minutes to read<nav id=TableOfContents><ul><li><a href=#problem-you-want-to-delete-more-than-one-key-at-a-time-probably-by-regex-pattern>Problem: You want to delete more than one key at a time, probably by regex pattern</a></li><li><a href=#using-regex-patterns-to-delete-multiple-keys>Using regex patterns to delete multiple keys</a></li><li><a href=#relevant-links>Relevant links</a></li></ul></nav><h2 id=problem-you-want-to-delete-more-than-one-key-at-a-time-probably-by-regex-pattern>Problem: You want to delete more than one key at a time, probably by regex pattern</h2><p>Using Redis, you might be using something like the following to delete keys:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#ff79c6>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>CacheManager</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>private</span> <span style=color:#ff79c6>readonly</span> IDistributedCache _cache;
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>public</span> CacheManager(IDDistributedCache cache) {
</span></span><span style=display:flex><span>         _cache = cache;
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>public</span> <span style=color:#ff79c6>async</span> Task RemoveKeys() {
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>await</span> Cache.RemoveAsync(<span style=color:#f1fa8c>&#34;key-1&#34;</span>);
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>await</span> Cache.RemoveAsync(<span style=color:#f1fa8c>&#34;key-2&#34;</span>);
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>await</span> Cache.RemoveAsync(<span style=color:#f1fa8c>&#34;key-3&#34;</span>);
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>The only problem with this approach is that we perform a round-trip for each key deletion, that is, we call the redis server at each deletion.
In times when latency is important, and the number of keys, this can make a big difference.
What if we could delete multiple keys?</p><h2 id=using-regex-patterns-to-delete-multiple-keys>Using regex patterns to delete multiple keys</h2><p>The first necessary change is to use an IConnectionMultiplexer, as we will need to run scripts directly on the redis instance.
Afterwards, execute a Lua script, which will be the following:</p><p><code>for i, name in ipairs(redis.call('KEYS', @prefix)) do redis.call('DEL', name); end</code></p><p>Going back to the code, we would end up with something like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#ff79c6>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>CacheManager</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>private</span> <span style=color:#ff79c6>readonly</span> IDistributedCache _cache; <span style=color:#6272a4>// Maybe you can keep this for use in other methods</span>
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>private</span> <span style=color:#ff79c6>readonly</span> IConnectionMultiplexer _multiplexer;
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>public</span> CacheManager(IDistributedCache cache, IConnectionMultiplexer multiplexer)
</span></span><span style=display:flex><span>     {
</span></span><span style=display:flex><span>         _cache = cache;
</span></span><span style=display:flex><span>         _multiplexer = multiplexer;
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>public</span> <span style=color:#ff79c6>async</span> Task RemoveKeys(<span style=color:#8be9fd>string</span> prefix)
</span></span><span style=display:flex><span>     {
</span></span><span style=display:flex><span>         <span style=color:#8be9fd>var</span> prepared = LuaScript.Prepare(<span style=color:#f1fa8c>&#34;for i, name in ipairs(redis.call(&#39;KEYS&#39;, @prefix)) do redis.call(&#39;DEL&#39;, name); end&#34;</span>);
</span></span><span style=display:flex><span>         <span style=color:#ff79c6>await</span> _multiplexer.GetDatabase().ScriptEvaluateAsync(prepared, <span style=color:#ff79c6>new</span> { prefix = prefix });
</span></span><span style=display:flex><span>     }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#6272a4>// Then, we use it like this:</span>
</span></span><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#ff79c6>await</span> manager.RemoveKeys(<span style=color:#f1fa8c>&#34;key-*&#34;</span>);
</span></span></code></pre></div><h2 id=relevant-links>Relevant links</h2><ul><li><a href=https://stackexchange.github.io/StackExchange.Redis/Scripting>https://stackexchange.github.io/StackExchange.Redis/Scripting</a></li><li><a href=https://stackoverflow.com/a/27561399/12881014>https://stackoverflow.com/a/27561399/12881014</a></li></ul></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/en/tags/dotnet>dotnet</a></li><li><a href=/en/tags/redis>redis</a></li><li><a href=/en/tags/key>key</a></li><li><a href=/en/tags/pattern>pattern</a></li><li><a href=/en/tags/delete>delete</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/yanpitangui rel=me title=GitHub><i data-feather=github></i></a>
<span class=border></span><a class=soc href=https://twitter.com/aethelingaeg rel=me title=Twitter><i data-feather=twitter></i></a>
<span class=border></span><a class=soc href=https://www.linkedin.com/in/yanpitangui/ rel=me title=Linkedin><i data-feather=linkedin></i></a>
<span class=border></span></div><div class=footer-info>2023 © Yan Pitangui | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-2YDP77JD9X","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script>
<script>document.addEventListener("DOMContentLoaded",()=>feather.replace())</script></div></body></html>