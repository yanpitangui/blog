<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Detecting if the application is running to create migrations - Yan Pitangui</title><script async src="https://www.googletagmanager.com/gtag/js?id=G-2YDP77JD9X"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-2YDP77JD9X",{anonymize_ip:!1})}</script><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Problem: Your DbContext has a scoped dependency Having a scoped dependency, for example in a multi-tenant application, where it injects some scoped service, such as TenantProvider or something like that, you will be unable to create migrations, as the application will not be able to resolve this dependency. But I have the solution!
See the following class as an example:
public class Session: ISession { public Session(IHttpContextAccessor httpContextAccessor) {...} } Solution One thing you can do is add one more constructor, where you manually add dependencies, like this:"><meta property="og:image" content><meta property="og:title" content="Detecting if the application is running to create migrations"><meta property="og:description" content="Problem: Your DbContext has a scoped dependency Having a scoped dependency, for example in a multi-tenant application, where it injects some scoped service, such as TenantProvider or something like that, you will be unable to create migrations, as the application will not be able to resolve this dependency. But I have the solution!
See the following class as an example:
public class Session: ISession { public Session(IHttpContextAccessor httpContextAccessor) {...} } Solution One thing you can do is add one more constructor, where you manually add dependencies, like this:"><meta property="og:type" content="article"><meta property="og:url" content="https://yanpitangui.com/en/posts/2023/06/detecting-if-the-application-is-running-to-create-migrations/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-15T00:52:58-03:00"><meta property="article:modified_time" content="2023-06-15T00:52:58-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Detecting if the application is running to create migrations"><meta name=twitter:description content="Problem: Your DbContext has a scoped dependency Having a scoped dependency, for example in a multi-tenant application, where it injects some scoped service, such as TenantProvider or something like that, you will be unable to create migrations, as the application will not be able to resolve this dependency. But I have the solution!
See the following class as an example:
public class Session: ISession { public Session(IHttpContextAccessor httpContextAccessor) {...} } Solution One thing you can do is add one more constructor, where you manually add dependencies, like this:"><script defer src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Roboto+Mono&display=swap" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://yanpitangui.com/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://yanpitangui.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://yanpitangui.com/>Yan Pitangui</a></div><nav><a href=/en/posts/>All posts</a>
<a href=/en/tags/>Tags</a>
<a href=/en/about/>About me</a>
| <span id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://yanpitangui.com/js/themetoggle.js></script><nav aria-label="Language switcher"><span aria-label=en style="border-bottom:3px solid var(--callouctcolor)">en</span>
<a title=pt style=border:none href=https://yanpitangui.com/pt/posts/2023/06/detectando-se-a-aplica%C3%A7%C3%A3o-est%C3%A1-rodando-para-criar-migrations/ aria-label=pt>pt</a></nav></nav></header><main><article><div class=title><h1 class=title>Detecting if the application is running to create migrations</h1><div class=meta>Posted on Thursday, June 15, 2023</div></div><section class=body>One minute to read<nav id=TableOfContents><ul><li><a href=#problem-your-dbcontext-has-a-scoped-dependency>Problem: Your DbContext has a scoped dependency</a></li><li><a href=#solution>Solution</a></li><li><a href=#full-code-sample>Full code sample</a></li></ul></nav><h2 id=problem-your-dbcontext-has-a-scoped-dependency>Problem: Your DbContext has a scoped dependency</h2><p>Having a scoped dependency, for example in a multi-tenant application, where it injects some scoped service, such as TenantProvider or something like that, you will be unable to create migrations, as the application will not be able to resolve this dependency. But I have the solution!</p><p>See the following class as an example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#ff79c6>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Session</span>: ISession {
</span></span><span style=display:flex><span>     <span style=color:#ff79c6>public</span> Session(IHttpContextAccessor httpContextAccessor) {...}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=solution>Solution</h2><p>One thing you can do is add one more constructor, where you manually add dependencies, like this:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#ff79c6>public</span> Session(Tenant tenant, Guid userId)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     Tenant = tenant;
</span></span><span style=display:flex><span>     UserId = userId;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Afterwards, use the following code to detect if it is running through EF, that is, there will be no request to capture data in the HttpContext.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd>var</span> isMigration = Assembly.GetEntryAssembly()?.FullName?.StartsWith(<span style=color:#f1fa8c>&#34;ef&#34;</span>) ?? <span style=color:#ff79c6>false</span>;
</span></span></code></pre></div><p>What this does is basically verify that your application is being called by EfCore.
With this, you can change the behavior of your application, in order to inject a singleton instead of a scoped dependency of your dependency.</p><p>Another way to do this, but in my view, more complicated, is using <a href="https://learn.microsoft.com/en-us/ef/core/cli/dbcontext-creation?tabs=dotnet-core-cli">DesignTimeDbContextFactory</a>.</p><h2 id=full-code-sample>Full code sample</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd>var</span> isMigration = Assembly.GetEntryAssembly()?.FullName?.StartsWith(<span style=color:#f1fa8c>&#34;ef&#34;</span>) ?? <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (isMigration)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     services.AddSingleton&lt;ISession&gt;(_ =&gt; <span style=color:#ff79c6>new</span> Session(tenantLocal, Session.Admin));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>     services.AddScoped&lt;ISession, Session&gt;();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/en/tags/dotnet>dotnet</a></li><li><a href=/en/tags/api>api</a></li><li><a href=/en/tags/ef>ef</a></li><li><a href=/en/tags/migrations>migrations</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/yanpitangui rel=me title=GitHub><i data-feather=github></i></a>
<span class=border></span><a class=soc href=https://twitter.com/aethelingaeg rel=me title=Twitter><i data-feather=twitter></i></a>
<span class=border></span><a class=soc href=https://www.linkedin.com/in/yanpitangui/ rel=me title=Linkedin><i data-feather=linkedin></i></a>
<span class=border></span></div><div class=footer-info>2023 Â© Yan Pitangui | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>document.addEventListener("DOMContentLoaded",()=>feather.replace())</script></div></body></html>