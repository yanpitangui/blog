<!doctype html><html><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><title>Detectando se a aplicação está rodando para criar migrations - Yan Pitangui</title><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Problema: Seu DbContext tem uma dependência scoped Tendo uma dependência scoped, como por exemplo numa aplicação multi tenant, onde injeta algum serviço scoped, como TenantProvider ou algo do tipo, você ficará impossibilitado(a) de criar migrations, pois a aplicação não conseguirá resolver essa dependência. Mas eu tenho a solução!
Veja a classe a seguir como exemplo:
public class Session: ISession { public Session(IHttpContextAccessor httpContextAccessor) {...} } Solução Uma coisa que pode ser feita é adicionar mais um construtor, onde você adiciona manualmente as dependências, como a seguir:"><meta property="og:image" content><meta property="og:title" content="Detectando se a aplicação está rodando para criar migrations"><meta property="og:description" content="Problema: Seu DbContext tem uma dependência scoped Tendo uma dependência scoped, como por exemplo numa aplicação multi tenant, onde injeta algum serviço scoped, como TenantProvider ou algo do tipo, você ficará impossibilitado(a) de criar migrations, pois a aplicação não conseguirá resolver essa dependência. Mas eu tenho a solução!
Veja a classe a seguir como exemplo:
public class Session: ISession { public Session(IHttpContextAccessor httpContextAccessor) {...} } Solução Uma coisa que pode ser feita é adicionar mais um construtor, onde você adiciona manualmente as dependências, como a seguir:"><meta property="og:type" content="article"><meta property="og:url" content="https://yanpitangui.com/pt/posts/2023/06/detectando-se-a-aplica%C3%A7%C3%A3o-est%C3%A1-rodando-para-criar-migrations/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-06-15T00:52:58-03:00"><meta property="article:modified_time" content="2023-06-15T00:52:58-03:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Detectando se a aplicação está rodando para criar migrations"><meta name=twitter:description content="Problema: Seu DbContext tem uma dependência scoped Tendo uma dependência scoped, como por exemplo numa aplicação multi tenant, onde injeta algum serviço scoped, como TenantProvider ou algo do tipo, você ficará impossibilitado(a) de criar migrations, pois a aplicação não conseguirá resolver essa dependência. Mas eu tenho a solução!
Veja a classe a seguir como exemplo:
public class Session: ISession { public Session(IHttpContextAccessor httpContextAccessor) {...} } Solução Uma coisa que pode ser feita é adicionar mais um construtor, onde você adiciona manualmente as dependências, como a seguir:"><script src=https://cdn.jsdelivr.net/npm/feather-icons/dist/feather.min.js></script>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@1,500&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css2?family=Fira+Sans&display=swap" rel=stylesheet><link href="https://fonts.googleapis.com/css?family=Roboto+Mono" rel=stylesheet><link rel=stylesheet type=text/css media=screen href=https://yanpitangui.com/css/main.ac08a4c9714baa859217f92f051deb58df2938ec352b506df655005dcaf98cc0.css><link id=darkModeStyle rel=stylesheet type=text/css href=https://yanpitangui.com/css/dark.726cd11ca6eb7c4f7d48eb420354f814e5c1b94281aaf8fd0511c1319f7f78a4.css disabled></head><body><div class=content><header><div class=main><a href=https://yanpitangui.com/>Yan Pitangui</a></div><nav><a href=/pt/posts/>Todos os posts</a>
<a href=/pt/tags/>Tags</a>
<a href=/pt/about/>Sobre mim</a>
| <span id=dark-mode-toggle onclick=toggleTheme()></span>
<script src=https://yanpitangui.com/js/themetoggle.js></script><nav aria-label="Language switcher"><span aria-label=pt style="border-bottom:3px solid var(--callouctcolor)">pt</span>
<a title=en style=border:none href=https://yanpitangui.com/en/posts/2023/06/detecting-if-the-application-is-running-to-create-migrations/ aria-label=en>en</a></nav></nav></header><main><article><div class=title><h1 class=title>Detectando se a aplicação está rodando para criar migrations</h1><div class=meta>Postado em quinta-feira, 15 de junho de 2023</div></div><section class=body>Um minuto para ler<nav id=TableOfContents><ul><li><a href=#problema-seu-dbcontext-tem-uma-dependência-scoped>Problema: Seu DbContext tem uma dependência scoped</a></li><li><a href=#solução>Solução</a></li><li><a href=#código-completo>Código completo</a></li></ul></nav><h2 id=problema-seu-dbcontext-tem-uma-dependência-scoped>Problema: Seu DbContext tem uma dependência scoped</h2><p>Tendo uma dependência scoped, como por exemplo numa aplicação multi tenant, onde injeta algum serviço scoped, como TenantProvider ou algo do tipo, você ficará impossibilitado(a) de criar migrations, pois a aplicação não conseguirá resolver essa dependência. Mas eu tenho a solução!</p><p>Veja a classe a seguir como exemplo:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#ff79c6>public</span> <span style=color:#ff79c6>class</span> <span style=color:#50fa7b>Session</span>: ISession {
</span></span><span style=display:flex><span>    <span style=color:#ff79c6>public</span> Session(IHttpContextAccessor httpContextAccessor) {...}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=solução>Solução</h2><p>Uma coisa que pode ser feita é adicionar mais um construtor, onde você adiciona manualmente as dependências, como a seguir:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#ff79c6>public</span> Session(Tenant tenant, Guid userId)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    Tenant = tenant;
</span></span><span style=display:flex><span>    UserId = userId;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Depois, utilize o código a seguir para detectar se está rodando através do EF, ou seja, não existirá request para se capturar dados no HttpContext.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd>var</span> isMigration = Assembly.GetEntryAssembly()?.FullName?.StartsWith(<span style=color:#f1fa8c>&#34;ef&#34;</span>) ?? <span style=color:#ff79c6>false</span>;
</span></span></code></pre></div><p>O que isso faz é basicamente verificar que a sua aplicação está sendo chamada pelo EfCore.
Com isso, você consegue mudar o comportamento da sua aplicação, afim de injetar um singleton ao invés de uma dependência scoped da sua dependência.</p><p>Uma outra maneira de se fazer isso, mas na minha visão, mais complicada, é utilizando <a href="https://learn.microsoft.com/en-us/ef/core/cli/dbcontext-creation?tabs=dotnet-core-cli">DesignTimeDbContextFactory</a>.</p><h2 id=código-completo>Código completo</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-csharp data-lang=csharp><span style=display:flex><span><span style=color:#8be9fd>var</span> isMigration = Assembly.GetEntryAssembly()?.FullName?.StartsWith(<span style=color:#f1fa8c>&#34;ef&#34;</span>) ?? <span style=color:#ff79c6>false</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ff79c6>if</span> (isMigration)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    services.AddSingleton&lt;ISession&gt;(_ =&gt; <span style=color:#ff79c6>new</span> Session(tenantLocal, Session.Admin));
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#ff79c6>else</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    services.AddScoped&lt;ISession, Session&gt;();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div></section><div class=post-tags><nav class="nav tags"><ul class=tags><li><a href=/pt/tags/dotnet>dotnet</a></li><li><a href=/pt/tags/api>api</a></li><li><a href=/pt/tags/ef>ef</a></li><li><a href=/pt/tags/migrations>migrations</a></li></ul></nav></div></article></main><footer><div style=display:flex><a class=soc href=https://github.com/yanpitangui rel=me title=GitHub><i data-feather=github></i></a>
<a class=border></a><a class=soc href=https://twitter.com/aethelingaeg rel=me title=Twitter><i data-feather=twitter></i></a>
<a class=border></a><a class=soc href=https://www.linkedin.com/in/yanpitangui/ rel=me title=Linkedin><i data-feather=linkedin></i></a>
<a class=border></a></div><div class=footer-info>2023 © Yan Pitangui | <a href=https://github.com/athul/archie>Archie Theme</a> | Built with <a href=https://gohugo.io>Hugo</a></div></footer><script>feather.replace()</script></div></body></html>